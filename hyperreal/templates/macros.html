{% macro render_feature(index_id, cluster_id, feature_id, field, value, score, context, highlight_feature_id=None) %}
<div>
    <a href="/index/{{ index_id }}/{{ 'cluster/{}/'.format(cluster_id) if context =='cluster' }}?feature_id={{ feature_id }}">
        <div class="feature">
            <span class="field">{{ field }}</span>
            <div class="value{% if feature_id == highlight_feature_id %} highlight{% endif %}">{{ value }}</div>
            <span class="score">{{ ("{:.2e}").format(score) }}</span>
        </div>
    </a>
</div>
{%- endmacro %}


{% macro render_cluster(index_id, cluster_id, features, cluster_score=None, highlight_cluster_id=None, highlight_feature_id=None, context='index') -%}
<div class="feature-cluster">
    <div class="cluster-header {% if cluster_id == highlight_cluster_id %}highlight{% endif %}">
        Cluster {{ cluster_id }} {% if cluster_score is not none %}- {{ "{:.2e}".format(cluster_score) }}{% endif %}
    </div>
    <ul class="compact-cluster">
        {% for feature_id, field, value, score in features %}
        <li >
            {{ render_feature(index_id, cluster_id, feature_id, field, value, score, context, highlight_feature_id=highlight_feature_id)}}
        </li>
        {% endfor %}
    </ul>

    {% if context == "index" %}
    <div class="cluster-footer">
        {% if highlight_feature_id is not none %}
        <a href="/index/{{ index_id }}/cluster/{{ cluster_id }}/?feature_id={{ highlight_feature_id }}">Intersect selected feature</a>
        {% elif highlight_cluster_id is not none %}
        <a href="/index/{{ index_id }}/cluster/{{ cluster_id }}/?filter_cluster_id={{ highlight_cluster_id }}">Intersect selected cluster</a>
        {% else %}
        <a href="/index/{{ index_id }}/cluster/{{ cluster_id }}"/>See  all in cluster</a>
        {% endif %}
        <a href="/index/{{ index_id }}/?cluster_id={{ cluster_id }}">Pivot</a>
        <label>
            Select for editing:
            <input type="checkbox" form="cluster_edit" name="cluster_id" value="{{ cluster_id }}">
        </label>
    </div>
    {% endif %}
</div>
{%- endmacro %}